# ADR-004: ハイブリッド描画モード（Geoman + カスタム円描画）

- 日付: 2025-01-17
- ステータス: 承認
- レイヤ: web
- 種別: Web/API
- 関連コンポーネント: components/Map/DrawingTools.tsx

---

## 1. 背景 / コンテキスト

- 目的・解決したいこと:
  - ユーザーが地図上で検索範囲を直感的に指定できるようにしたい
  - 多角形と円の2種類の描画モードを提供したい

- 前提・制約:
  - Leaflet Geomanは多角形描画に優れているが、円描画のUXが直感的でない
  - 円描画は「中心→半径」より「バウンディングボックス」の方が意図した範囲を指定しやすい
  - 誤操作防止のため最小半径（100m）を設けたい

- この ADR がカバーする範囲:
  - 描画モードの実装方式の決定
  - UXトレードオフの説明

---

## 2. 決定

**多角形描画にはLeaflet Geoman**を使用し、**円描画はカスタム実装**（バウンディングボックスに内接する円）を採用する。

- 多角形: `map.pm.enableDraw('Polygon')` + スナッピング + 編集可能
- 円: mousedown/mousemove/mouseup でドラッグ → バウンディングボックス内接円を生成

---

## 3. 選択肢と評価

### 採用案（本 ADR の決定）

- 概要:
  - 多角形: Leaflet Geoman
  - 円: カスタム実装（ドラッグでバウンディングボックス → 内接円）
- メリット:
  - 多角形は豊富な機能（スナッピング、自己交差防止、編集）
  - 円は直感的な「範囲ドラッグ」で指定可能
  - 最小半径チェックで誤操作防止
- デメリット / リスク:
  - 2つの異なる実装を維持する必要がある
  - カスタム円描画のテスト・メンテナンスコスト

### 代替案 A: Leaflet Geomanの円描画をそのまま使用

- 概要: `map.pm.enableDraw('Circle')` を使用
- 採用しなかった理由:
  - 「中心点クリック → 半径ドラッグ」のUXが直感的でない
  - ユーザーは「この範囲」と面で考えるが、円描画は点から考える必要がある

### 代替案 B: 円描画を廃止し多角形のみ

- 概要: 多角形描画だけを提供
- 採用しなかった理由:
  - 「駅から○km」のような使い方で円が便利
  - 多角形は頂点数が多いと操作が煩雑

---

## 4. 根拠（評価軸と判断）

- ビジョンとの整合:
  - 「直感的な操作」を重視

- UXトレードオフ:
  | 操作 | Geoman円 | カスタム円（採用） |
  |------|----------|-------------------|
  | 指定方法 | 中心→半径 | 角から角へドラッグ |
  | 直感性 | △ | ◎ |
  | 精度 | ◎（正確な中心） | ○（内接円） |
  | 学習コスト | △ | ◎ |

- 誤操作防止:
  - 最小半径100mで極小の円を防止
  - プレビュー表示で結果を事前確認

---

## 5. 影響範囲

- コード / ディレクトリ構成:
  - `src/components/Map/DrawingTools.tsx`
    - `handlePolygonMode()` - Geoman連携
    - `handleCircleMode()` - カスタム実装
    - `createCircleFromBBox()` - 内接円生成

- 既存・将来のコンポーネント:
  - Toolbarの描画モードボタンと連携
  - 将来の長方形モード等も同様のパターンで追加可能

- 運用プロセス:
  - 描画後は両モードともドラッグで移動可能

---

## 6. ロールアウト / 移行方針

- フェーズ:
  - 初期実装で完了済み

- 具体的ステップ:
  1. Leaflet Geomanをnpm install
  2. 多角形モードはGeomanのenableDraw('Polygon')を使用
  3. 円モードはマウスイベントをフックしてカスタム実装
  4. 両モードでpm:dragendイベントをリッスンして駅リスト更新

---

## 7. オープンな論点 / フォローアップ

- open question:
  - 「中心点 + 半径スライダー」UIの追加検討
  - 複数エリアの同時描画サポート

- 別 ADR に切る予定のテーマ:
  - なし

---

## 8. 関連 ADR

- ADR-003: React + Leaflet統合パターン
