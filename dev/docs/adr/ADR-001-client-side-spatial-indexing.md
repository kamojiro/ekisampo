# ADR-001: クライアントサイド空間インデックス（RBush + Turf.js）

- 日付: 2025-01-17
- ステータス: 承認
- レイヤ: core
- 種別: データストア
- 関連コンポーネント: lib/spatialIndex.ts / lib/stationSearch.ts / hooks/useStations.ts

---

## 1. 背景 / コンテキスト

- 目的・解決したいこと:
  - ユーザーが地図上で描画した範囲（多角形・円）内の駅を高速に検索したい
  - 描画中のドラッグイベントでもリアルタイムに駅数を更新したい

- 前提・制約:
  - 東京エリアの約140駅のデータセット
  - フロントエンドのみで完結させたい（バックエンドなし）
  - GeoJSON形式でデータを管理

- この ADR がカバーする範囲:
  - 空間検索のアルゴリズム選定とインデックス戦略のみ
  - データソース（stations.json）の構造は別ADRで扱う

---

## 2. 決定

**RBushによるR-treeインデックス**と**Turf.jsによる精密幾何学計算**の2段階フィルタリングを採用する。

1. データロード時にR-treeインデックスを構築
2. 検索時はまずバウンディングボックスでR-tree検索（候補絞り込み）
3. 候補に対してTurf.jsでpoint-in-polygon判定（精密フィルタ）

---

## 3. 選択肢と評価

### 採用案（本 ADR の決定）

- 概要:
  - RBush（R-tree実装）+ Turf.js（幾何計算）のクライアントサイド2段階フィルタリング
- メリット:
  - O(log n)の高速なバウンディングボックス検索
  - サーバーインフラ不要、オフライン動作可能
  - point-in-polygon計算を約85%削減（140駅→20〜30候補）
- デメリット / リスク:
  - クライアントメモリ消費（約50KB程度）
  - 10,000駅以上へのスケールには不向き

### 代替案 A: サーバーサイド空間DB（PostGIS/Elasticsearch）

- 概要: 空間検索をバックエンドAPIで処理
- 採用しなかった理由:
  - 140駅程度のデータセットにはオーバーエンジニアリング
  - インフラコスト・運用負荷が発生
  - ネットワーク遅延でリアルタイム更新が困難

### 代替案 B: 単純なO(n)フィルタリング

- 概要: 全駅に対して毎回point-in-polygon判定
- 採用しなかった理由:
  - 描画中のドラッグイベントで遅延が発生
  - 駅数が増えた場合にパフォーマンス劣化

---

## 4. 根拠（評価軸と判断）

- ビジョンとの整合:
  - 「バックエンドなしで完結」という方針に合致
  - PWA化・オフライン対応の可能性を残す

- 非機能要件:
  - リアルタイム性: ドラッグ中でも16ms以内で応答
  - 初期ロード: インデックス構築は50ms未満

- スキル・運用コスト:
  - RBush/Turf.jsは軽量で学習コストが低い
  - クライアントサイドのみなのでデプロイが簡単

---

## 5. 影響範囲

- コード / ディレクトリ構成:
  - `src/lib/spatialIndex.ts` - R-treeインデックスの構築・検索
  - `src/lib/stationSearch.ts` - 2段階フィルタリングロジック
  - `src/hooks/useStations.ts` - データロード時にインデックス構築

- 既存・将来のコンポーネント:
  - DrawingToolsがエリア変更時にstationSearchを呼び出す
  - 将来の路線フィルタリングもこのインデックスを活用可能

- 運用プロセス:
  - stations.jsonの更新時は自動的に再インデックス

---

## 6. ロールアウト / 移行方針

- フェーズ:
  - 初期実装で完了済み

- 具体的ステップ:
  1. RBush/Turf.jsをnpm install
  2. spatialIndex.tsでbuildSpatialIndex関数を実装
  3. stationSearch.tsでfindStationsInArea関数を実装
  4. useStationsフックでデータロード後にインデックス構築

---

## 7. オープンな論点 / フォローアップ

- open question:
  - 駅数が1,000を超えた場合のパフォーマンス検証
  - Web Worker化による初期ロードの非同期化

- 別 ADR に切る予定のテーマ:
  - stations.jsonのデータ構造・更新フロー

---

## 8. 関連 ADR

- ADR-006: 静的GeoJSONデータアーキテクチャ
